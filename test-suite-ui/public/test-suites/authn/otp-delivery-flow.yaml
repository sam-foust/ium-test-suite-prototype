metadata:
  title: "OTP Delivery Flow Test Suite"
  feature: "OTP Delivery"
  createdBy: "Sam Foust"
  dateCreated: "2025-12-09"
  lastUpdated: "2025-12-09"
  status: "Draft"

featureInformation:
  feature: "OTP (One-Time Password) Delivery Testing for Forgot Password Flow"
  details:
    - "Tests how OTP codes are delivered via email in forgot password scenarios"
    - "Validates single code delivery for unique email addresses"
    - "Tests multiple code delivery when multiple accounts share same email across tenants"
    - "Verifies correct code selection and password reset functionality"
    - "Platform Coverage: Web browser (Employee)"

preSetup:
  purpose: "Set up test employees with email-only accounts to test OTP delivery logic. First employee has unique email, second employee (in different tenant) shares the same email address."
  tenantSetup:
    - "Create or use Tenant 1 with email service configured and accessible"
    - "Create or use Tenant 2 (different tenant) with email service configured and accessible"
    - "Ensure email service is accessible for both tenants"
    - "Ensure SMS service is configured (to verify no SMS codes are sent)"
  userAccounts:
    - prerequisite: "PRE-01 (Employee 1 - Email Only - Unique Email)"
      quantity: 1
      notes: "Create 1 employee account in Tenant 1 with validated email [Employee1Email] and NO phone number - ensure this is the ONLY active account with this email address initially"
    - prerequisite: "PRE-02 (Employee 2 - Email Only - Shared Email)"
      quantity: 1
      notes: "Create 1 employee account in Tenant 2 with same validated email [Employee2Email] (same as [Employee1Email]) and NO phone number - this will be created during TC-02.1"
  checklistItems:
    - "Tenant 1 configured with email service"
    - "Tenant 2 configured with email service"
    - "SMS service configured (to verify no SMS codes are sent)"
    - "1x PRE-01 Employee created in Tenant 1 with unique email [Employee1Email], no phone"
    - "Email [Employee1Email] is validated"
    - "Employee 1 is the ONLY active account with [Employee1Email] initially"
    - "All usernames, emails, and passwords documented in Test Variables Tracker"

executionMatrix:
  important: "All test cases must verify the correct number of OTP codes delivered (single code for unique email, multiple codes for shared email) and that NO SMS codes are generated."
  matrix:
    - userType: "Employee 1 (Tenant 1 - Unique Email)"
      platform: "Web Browser"
      variableSet: "[Employee1Username], [Employee1Email], [EmailOTPCode1], [Password1], [Password2]"
      executionStatus: "Incomplete"
    - userType: "Employee 2 (Tenant 2 - Shared Email)"
      platform: "Web Browser"
      variableSet: "[Employee2Username], [Employee2Email], [EmailOTPCode2], [Password1], [Password3]"
      executionStatus: "Incomplete"
  instructions:
    - "Execute TC-01 first to test single employee with unique email"
    - "Execute TC-02 after TC-01 to test shared email scenario"
    - "Execute TC-03 to verify both employees can still login independently"
    - "Verify OTP code counts in emails match expected values"
    - "Verify NO SMS codes are generated at any point"
    - "Document actual OTP codes received in Test Variables Tracker"
  executionFlow:
    - "First Pass: Execute TC-01 using Employee 1 (Tenant 1) on web browser - verify single code delivery"
    - "Second Pass: Execute TC-02.1 to create Employee 2 (Tenant 2) with shared email"
    - "Third Pass: Execute TC-02.2 through TC-02.6 using Employee 2 - verify multiple code delivery"
    - "Fourth Pass: Execute TC-03 to verify both employees can login independently"

prerequisites:
  - id: "PRE-01"
    dataObject: "Active Employee Account in Tenant 1 with Email Only (No Phone) - Unique Email"
    steps:
      - "Ensure Tenant 1 has email service configured"
      - "Impersonate as owner in Tenant 1"
      - "Go to employee add page"
      - "Create a new employee with validated email address [Employee1Email]"
      - "Leave phone number field EMPTY (no phone number)"
      - "Ensure email is validated"
      - "Create user by supplying [Employee1Username] and [Password1]"
      - "Verify this is the ONLY active account with [Employee1Email] across all tenants"
      - "Verify employee has no phone number configured"
  - id: "PRE-02"
    dataObject: "Active Employee Account in Tenant 2 with Email Only (No Phone) - Shared Email"
    steps:
      - "Ensure Tenant 2 has email service configured"
      - "Impersonate as owner in Tenant 2"
      - "Go to employee add page"
      - "Create a new employee with validated email address [Employee2Email] (same as [Employee1Email])"
      - "Leave phone number field EMPTY (no phone number)"
      - "Ensure email is validated"
      - "Create user by supplying [Employee2Username] and [Password1]"
      - "Verify both Employee 1 (Tenant 1) and Employee 2 (Tenant 2) now share the same email address"
      - "Verify employee has no phone number configured"
      - "Note: This prerequisite is created during TC-02.1 test case execution"

testVariables:
  - category: "Employee 1 Variables (Tenant 1)"
    variables:
      - name: "[Employee1Username]"
        actualValue: ""
        notes: "First employee username (Tenant 1)"
      - name: "[Employee1Email]"
        actualValue: ""
        notes: "Employee 1 email address (validated, unique initially)"
      - name: "[EmailOTPCode1]"
        actualValue: ""
        notes: "OTP code received via email for Employee 1 (first reset)"
      - name: "[Password1]"
        actualValue: ""
        notes: "Initial password for Employee 1"
      - name: "[Password2]"
        actualValue: ""
        notes: "Password set by Employee 1 after first reset"
  - category: "Employee 2 Variables (Tenant 2)"
    variables:
      - name: "[Employee2Username]"
        actualValue: ""
        notes: "Second employee username (Tenant 2, shares email with Employee 1)"
      - name: "[Employee2Email]"
        actualValue: ""
        notes: "Employee 2 email address (same as Employee 1, validated)"
      - name: "[EmailOTPCode2]"
        actualValue: ""
        notes: "OTP code received via email for Employee 2 (second reset, email contains 2 codes)"
      - name: "[Password3]"
        actualValue: ""
        notes: "Password set by Employee 2 after reset"

testScenarios:
  - id: "TC-01"
    title: "Single Employee - Unique Email - Single Code Delivery"
    description: "Tests OTP delivery for an employee account with a unique email address and no phone number. Verifies that only one email code is sent and no SMS codes are generated."
    testCases:
      - testId: "TC-01.1"
        title: "Request Password Reset - Employee with Unique Email"
        prerequisiteReference: "Uses Employee 1 (Tenant 1)"
        actionSteps:
          - "Navigate to login page (sign out if logged in)"
          - "Click \"Forgot Password\" link"
          - "Enter [Employee1Username] from Tenant 1"
          - "Click Submit"
        expectedResult:
          - "User is redirected to page prompting for username, email, or phone number"
          - "After submit, user receives confirmation message"
          - "System initiates password reset process"
        notes: ""
      - testId: "TC-01.2"
        title: "Verify Single Email Code Delivery - No SMS"
        prerequisiteReference: "Continues from TC-01.1"
        actionSteps:
          - "Check [Employee1Email] inbox for password reset email"
          - "Verify only ONE email is received"
          - "Verify email contains exactly ONE OTP code"
          - "Copy verification code from email to [EmailOTPCode1]"
          - "Verify NO SMS messages were sent or generated"
          - "Verify NO SMS codes were created in the system"
        expectedResult:
          - "Exactly ONE email received at [Employee1Email]"
          - "Email contains exactly ONE OTP verification code"
          - "Code copied to [EmailOTPCode1]"
          - "NO SMS messages sent (employee has no phone number)"
          - "NO SMS codes generated or sent to any phone number"
          - "System only generated one code (email code)"
        notes: "This validates that email-only accounts with unique emails receive exactly one code via email only"
      - testId: "TC-01.3"
        title: "Enter Code and System Accepts"
        prerequisiteReference: "Continues from TC-01.2"
        actionSteps:
          - "Enter [EmailOTPCode1] on the screen prompting for code"
          - "Submit"
        expectedResult:
          - "Code is accepted successfully"
          - "User is taken to password reset screen"
          - "No error messages displayed"
        notes: ""
      - testId: "TC-01.4"
        title: "Change Password to Password2"
        prerequisiteReference: "Continues from TC-01.3"
        actionSteps:
          - "On password reset screen, enter [Password2] as new password"
          - "Confirm password ([Password2])"
          - "Save"
        expectedResult:
          - "Password reset is successful"
          - "User is redirected back to login screen"
          - "Confirmation message displayed"
        notes: ""
      - testId: "TC-01.5"
        title: "Login with Password2"
        prerequisiteReference: "Continues from TC-01.4"
        actionSteps:
          - "Enter [Employee1Username]"
          - "Enter [Password2]"
          - "Submit login"
        expectedResult:
          - "User successfully logs into the application"
          - "User lands on application home/dashboard"
        notes: ""
  - id: "TC-02"
    title: "Shared Email Across Tenants - Multiple Code Delivery"
    description: "Tests OTP delivery when a second employee in a different tenant shares the same email address. Verifies that the email contains multiple codes (one for each employee) and user can select the correct code."
    testCases:
      - testId: "TC-02.1"
        title: "Create Second Employee in Different Tenant with Same Email"
        prerequisiteReference: "Setup for TC-02"
        actionSteps:
          - "Navigate to Tenant 2 (different tenant from Employee 1)"
          - "Create a new active employee account"
          - "Set email address to [Employee2Email] (same as [Employee1Email])"
          - "Leave phone number field EMPTY (no phone number)"
          - "Ensure email is validated"
          - "Create user by supplying [Employee2Username] and [Password1]"
        expectedResult:
          - "Second employee account created successfully in Tenant 2"
          - "Employee 2 has same email address as Employee 1: [Employee2Email]"
          - "Employee 2 has no phone number"
          - "Email address is validated"
          - "Both Employee 1 (Tenant 1) and Employee 2 (Tenant 2) now share the same email"
        notes: ""
      - testId: "TC-02.2"
        title: "Request Password Reset - Employee 2 with Shared Email"
        prerequisiteReference: "Continues from TC-02.1"
        actionSteps:
          - "Navigate to login page (sign out if logged in)"
          - "Click \"Forgot Password\" link"
          - "Enter [Employee2Username] (the new username from Tenant 2)"
          - "Click Submit"
        expectedResult:
          - "User is redirected to page prompting for username, email, or phone number"
          - "After submit, user receives confirmation message"
          - "System initiates password reset process"
        notes: ""
      - testId: "TC-02.3"
        title: "Verify Multiple Codes in Single Email - No SMS"
        prerequisiteReference: "Continues from TC-02.2"
        actionSteps:
          - "Check [Employee2Email] inbox for password reset email"
          - "Verify only ONE email is received"
          - "Verify email contains exactly TWO OTP codes"
          - "Identify which code is for Employee 1 (Tenant 1)"
          - "Identify which code is for Employee 2 (Tenant 2)"
          - "Copy verification code for Employee 2 to [EmailOTPCode2]"
          - "Verify NO SMS messages were sent or generated"
          - "Verify NO SMS codes were created in the system"
        expectedResult:
          - "Exactly ONE email received at [Employee2Email]"
          - "Email contains exactly TWO OTP verification codes"
          - "One code is for Employee 1 (Tenant 1)"
          - "One code is for Employee 2 (Tenant 2)"
          - "Code for Employee 2 copied to [EmailOTPCode2]"
          - "NO SMS messages sent (neither employee has phone number)"
          - "NO SMS codes generated or sent to any phone number"
          - "System generated two codes (both email codes)"
        notes: "This validates that when multiple accounts share an email across tenants, the email contains multiple codes"
      - testId: "TC-02.4"
        title: "Enter Code for Employee 2"
        prerequisiteReference: "Continues from TC-02.3"
        actionSteps:
          - "Enter [EmailOTPCode2] (the code for Employee 2) on the screen prompting for code"
          - "Submit"
        expectedResult:
          - "Code is accepted successfully"
          - "User is taken to password reset screen for Employee 2"
          - "No error messages displayed"
        notes: ""
      - testId: "TC-02.5"
        title: "Set New Password3 for Employee 2"
        prerequisiteReference: "Continues from TC-02.4"
        actionSteps:
          - "On password reset screen, enter [Password3] as new password"
          - "Confirm password ([Password3])"
          - "Save"
        expectedResult:
          - "Password reset is successful for Employee 2"
          - "User is redirected back to login screen"
          - "Confirmation message displayed"
        notes: ""
      - testId: "TC-02.6"
        title: "Login with Password3 - Employee 2"
        prerequisiteReference: "Continues from TC-02.5"
        actionSteps:
          - "Enter [Employee2Username]"
          - "Enter [Password3]"
          - "Submit login"
        expectedResult:
          - "Employee 2 successfully logs into the application"
          - "Employee 2 lands on application home/dashboard"
        notes: ""
  - id: "TC-03"
    title: "Verify Both Employees Can Still Login"
    description: "Verifies that after Employee 2's password reset, both employees can still login with their respective passwords."
    testCases:
      - testId: "TC-03.1"
        title: "Employee 1 Can Still Login with Password2"
        prerequisiteReference: "Uses Employee 1 (Tenant 1)"
        actionSteps:
          - "Navigate to login page (sign out if logged in)"
          - "Enter [Employee1Username]"
          - "Enter [Password2]"
          - "Submit login"
        expectedResult:
          - "Employee 1 successfully logs into the application"
          - "Employee 1 lands on application home/dashboard"
          - "Password2 is still valid for Employee 1"
        notes: "This validates that Employee 1's password was not affected by Employee 2's password reset"
      - testId: "TC-03.2"
        title: "Employee 2 Can Login with Password3"
        prerequisiteReference: "Uses Employee 2 (Tenant 2)"
        actionSteps:
          - "Navigate to login page (sign out if logged in)"
          - "Enter [Employee2Username]"
          - "Enter [Password3]"
          - "Submit login"
        expectedResult:
          - "Employee 2 successfully logs into the application"
          - "Employee 2 lands on application home/dashboard"
          - "Password3 is valid for Employee 2"
        notes: "This validates that Employee 2's password reset was successful and independent"
